{"version":3,"sources":["../../src/redis/accelerator.ts"],"names":[],"mappings":"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","file":"index.mjs","sourcesContent":["/**\r\n * @rootlodge/reality-server - Redis Accelerator\r\n * \r\n * Optional Redis layer for invalidation hints and mesh acceleration.\r\n * IMPORTANT: This is acceleration only - correctness MUST NOT depend on Redis.\r\n */\r\n\r\nimport type { RealityNodeMeta, GossipPayload } from '../types';\r\n\r\n/**\r\n * Redis client interface (minimal subset)\r\n */\r\nexport interface RedisClient {\r\n  get(key: string): Promise<string | null>;\r\n  set(key: string, value: string, options?: { EX?: number }): Promise<void>;\r\n  del(key: string): Promise<void>;\r\n  publish(channel: string, message: string): Promise<void>;\r\n  subscribe(channel: string, callback: (message: string) => void): Promise<void>;\r\n  unsubscribe(channel: string): Promise<void>;\r\n  ping(): Promise<string>;\r\n  quit(): Promise<void>;\r\n}\r\n\r\n/**\r\n * Redis accelerator configuration\r\n */\r\nexport interface RedisAcceleratorConfig {\r\n  /** Redis client instance */\r\n  client: RedisClient;\r\n  /** Key prefix for Reality data */\r\n  prefix?: string;\r\n  /** TTL for cached data in seconds */\r\n  ttl?: number;\r\n  /** Enable pub/sub for invalidation hints */\r\n  pubSubEnabled?: boolean;\r\n  /** Server ID for pub/sub filtering */\r\n  serverId?: string;\r\n  /** Debug logging */\r\n  debug?: boolean;\r\n}\r\n\r\n/**\r\n * Redis Accelerator\r\n * \r\n * Provides optional acceleration for:\r\n * - Invalidation hint propagation (pub/sub)\r\n * - Mesh gossip caching\r\n * - Hot node metadata caching\r\n * \r\n * CRITICAL: All operations are best-effort.\r\n * The system MUST work correctly without Redis.\r\n */\r\nexport class RedisAccelerator {\r\n  private client: RedisClient;\r\n  private prefix: string;\r\n  private ttl: number;\r\n  private pubSubEnabled: boolean;\r\n  private serverId: string;\r\n  private debug: boolean;\r\n  private invalidationHandlers: Set<(keys: string[], source: string) => void> = new Set();\r\n  private connected = false;\r\n\r\n  constructor(config: RedisAcceleratorConfig) {\r\n    this.client = config.client;\r\n    this.prefix = config.prefix ?? 'reality:';\r\n    this.ttl = config.ttl ?? 60;\r\n    this.pubSubEnabled = config.pubSubEnabled ?? true;\r\n    this.serverId = config.serverId ?? 'unknown';\r\n    this.debug = config.debug ?? false;\r\n  }\r\n\r\n  /**\r\n   * Initialize Redis connection and pub/sub\r\n   */\r\n  async connect(): Promise<boolean> {\r\n    try {\r\n      await this.client.ping();\r\n      this.connected = true;\r\n\r\n      if (this.pubSubEnabled) {\r\n        await this.setupPubSub();\r\n      }\r\n\r\n      if (this.debug) {\r\n        console.log('[Redis] Connected successfully');\r\n      }\r\n\r\n      return true;\r\n    } catch (error) {\r\n      if (this.debug) {\r\n        console.warn('[Redis] Connection failed:', error);\r\n      }\r\n      this.connected = false;\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Disconnect from Redis\r\n   */\r\n  async disconnect(): Promise<void> {\r\n    try {\r\n      if (this.pubSubEnabled) {\r\n        await this.client.unsubscribe(`${this.prefix}invalidations`);\r\n      }\r\n      await this.client.quit();\r\n      this.connected = false;\r\n    } catch {\r\n      // Ignore disconnect errors\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Check if Redis is connected\r\n   */\r\n  isConnected(): boolean {\r\n    return this.connected;\r\n  }\r\n\r\n  /**\r\n   * Cache node metadata\r\n   */\r\n  async cacheNode(meta: RealityNodeMeta): Promise<void> {\r\n    if (!this.connected) return;\r\n\r\n    try {\r\n      const key = `${this.prefix}node:${meta.key}`;\r\n      await this.client.set(key, JSON.stringify(meta), { EX: this.ttl });\r\n    } catch (error) {\r\n      if (this.debug) {\r\n        console.warn('[Redis] Cache node failed:', error);\r\n      }\r\n      // Non-fatal - continue without cache\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get cached node metadata\r\n   */\r\n  async getCachedNode(key: string): Promise<RealityNodeMeta | null> {\r\n    if (!this.connected) return null;\r\n\r\n    try {\r\n      const data = await this.client.get(`${this.prefix}node:${key}`);\r\n      if (!data) return null;\r\n      return JSON.parse(data) as RealityNodeMeta;\r\n    } catch {\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Invalidate cached node\r\n   */\r\n  async invalidateCache(key: string): Promise<void> {\r\n    if (!this.connected) return;\r\n\r\n    try {\r\n      await this.client.del(`${this.prefix}node:${key}`);\r\n    } catch {\r\n      // Non-fatal\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Publish invalidation hint to other servers\r\n   * \r\n   * This is a HINT only. Servers receiving this can:\r\n   * - Proactively sync their storage\r\n   * - Pre-warm caches\r\n   * - Notify waiting clients early\r\n   * \r\n   * BUT: They MUST NOT rely on this for correctness.\r\n   */\r\n  async publishInvalidation(keys: string[]): Promise<void> {\r\n    if (!this.connected || !this.pubSubEnabled) return;\r\n\r\n    try {\r\n      const message = JSON.stringify({\r\n        keys,\r\n        source: this.serverId,\r\n        timestamp: Date.now(),\r\n      });\r\n\r\n      await this.client.publish(`${this.prefix}invalidations`, message);\r\n\r\n      if (this.debug) {\r\n        console.log(`[Redis] Published invalidation for ${keys.length} keys`);\r\n      }\r\n    } catch (error) {\r\n      if (this.debug) {\r\n        console.warn('[Redis] Publish invalidation failed:', error);\r\n      }\r\n      // Non-fatal - continue without pub/sub\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Register handler for invalidation hints\r\n   */\r\n  onInvalidation(handler: (keys: string[], source: string) => void): () => void {\r\n    this.invalidationHandlers.add(handler);\r\n    return () => this.invalidationHandlers.delete(handler);\r\n  }\r\n\r\n  /**\r\n   * Cache mesh gossip for quick peer discovery\r\n   */\r\n  async cacheGossip(gossip: GossipPayload): Promise<void> {\r\n    if (!this.connected) return;\r\n\r\n    try {\r\n      const key = `${this.prefix}gossip:${gossip.serverId}`;\r\n      await this.client.set(key, JSON.stringify(gossip), { EX: this.ttl });\r\n    } catch {\r\n      // Non-fatal\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get cached gossip from a server\r\n   */\r\n  async getCachedGossip(serverId: string): Promise<GossipPayload | null> {\r\n    if (!this.connected) return null;\r\n\r\n    try {\r\n      const data = await this.client.get(`${this.prefix}gossip:${serverId}`);\r\n      if (!data) return null;\r\n      return JSON.parse(data) as GossipPayload;\r\n    } catch {\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Set up pub/sub subscriptions\r\n   */\r\n  private async setupPubSub(): Promise<void> {\r\n    try {\r\n      await this.client.subscribe(\r\n        `${this.prefix}invalidations`,\r\n        (message: string) => {\r\n          try {\r\n            const data = JSON.parse(message) as {\r\n              keys: string[];\r\n              source: string;\r\n              timestamp: number;\r\n            };\r\n\r\n            // Ignore our own messages\r\n            if (data.source === this.serverId) return;\r\n\r\n            // Notify handlers\r\n            for (const handler of this.invalidationHandlers) {\r\n              try {\r\n                handler(data.keys, data.source);\r\n              } catch {\r\n                // Ignore handler errors\r\n              }\r\n            }\r\n          } catch {\r\n            // Ignore invalid messages\r\n          }\r\n        }\r\n      );\r\n    } catch (error) {\r\n      if (this.debug) {\r\n        console.warn('[Redis] Pub/sub setup failed:', error);\r\n      }\r\n      // Non-fatal - continue without pub/sub\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get accelerator statistics\r\n   */\r\n  getStats(): {\r\n    connected: boolean;\r\n    pubSubEnabled: boolean;\r\n    handlerCount: number;\r\n  } {\r\n    return {\r\n      connected: this.connected,\r\n      pubSubEnabled: this.pubSubEnabled,\r\n      handlerCount: this.invalidationHandlers.size,\r\n    };\r\n  }\r\n}\r\n\r\n/**\r\n * Create Redis accelerator\r\n */\r\nexport function createRedisAccelerator(config: RedisAcceleratorConfig): RedisAccelerator {\r\n  return new RedisAccelerator(config);\r\n}\r\n"]}