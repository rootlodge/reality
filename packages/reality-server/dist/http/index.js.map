{"version":3,"sources":["../../src/types/index.ts","../../src/http/handlers.ts","../../src/http/express.ts","../../src/http/fetch.ts"],"names":["z","toRealityRequest"],"mappings":"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","file":"index.js","sourcesContent":["/**\r\n * @rootlodge/reality-server - Server Types\r\n * \r\n * Type definitions for the Reality server.\r\n * Shared types are duplicated here to avoid circular dependencies.\r\n */\r\n\r\nimport { z } from 'zod';\r\n\r\n// ============================================================================\r\n// Shared Types (duplicated from @rootlodge/reality for independence)\r\n// ============================================================================\r\n\r\nexport const RealityModeSchema = z.enum(['native', 'sse-compat', 'polling-compat']);\r\nexport type RealityMode = z.infer<typeof RealityModeSchema>;\r\n\r\nexport const SyncHintSchema = z.enum(['interaction', 'focus', 'idle', 'mutation', 'mount', 'reconnect']);\r\nexport type SyncHint = z.infer<typeof SyncHintSchema>;\r\n\r\nexport const RealityNodeMetaSchema = z.object({\r\n  key: z.string(),\r\n  version: z.number().int().nonnegative(),\r\n  hash: z.string(),\r\n  updatedAt: z.number().int(),\r\n});\r\n\r\nexport type RealityNodeMeta = z.infer<typeof RealityNodeMetaSchema>;\r\n\r\nexport const PeerHealthSchema = z.enum(['healthy', 'degraded', 'unhealthy', 'unknown']);\r\nexport type PeerHealth = z.infer<typeof PeerHealthSchema>;\r\n\r\nexport const PeerSummarySchema = z.object({\r\n  peer: z.string().url(),\r\n  maxVersionSeen: z.number().int().nonnegative(),\r\n  lastSeen: z.number().int(),\r\n  health: PeerHealthSchema.optional(),\r\n});\r\n\r\nexport type PeerSummary = z.infer<typeof PeerSummarySchema>;\r\n\r\nexport const SyncRequestSchema = z.object({\r\n  known: z.record(z.string(), z.number().int().nonnegative()),\r\n  clientId: z.string().uuid(),\r\n  mode: RealityModeSchema,\r\n  hint: SyncHintSchema,\r\n  timestamp: z.number().int().optional(),\r\n});\r\n\r\nexport type SyncRequest = z.infer<typeof SyncRequestSchema>;\r\n\r\nexport const ChangedNodeSchema = z.object({\r\n  version: z.number().int().nonnegative(),\r\n  hash: z.string(),\r\n  source: z.string().optional(),\r\n  payload: z.unknown().optional(),\r\n});\r\n\r\nexport type ChangedNode = z.infer<typeof ChangedNodeSchema>;\r\n\r\nexport const MeshInfoSchema = z.object({\r\n  peers: z.record(z.string(), PeerHealthSchema),\r\n  serverVersion: z.number().int().nonnegative().optional(),\r\n});\r\n\r\nexport type MeshInfo = z.infer<typeof MeshInfoSchema>;\r\n\r\nexport const SyncResponseSchema = z.object({\r\n  changed: z.record(z.string(), ChangedNodeSchema),\r\n  mesh: MeshInfoSchema,\r\n  serverTime: z.number().int(),\r\n});\r\n\r\nexport type SyncResponse = z.infer<typeof SyncResponseSchema>;\r\n\r\n// ============================================================================\r\n// Execution & Persistence Modes\r\n// ============================================================================\r\n\r\n/**\r\n * Persistence mode for Reality\r\n * - 'none': No database required, in-memory only\r\n * - 'advisory': Optional DB adapters for invalidation hints\r\n * - 'external': Application manages its own persistence\r\n */\r\nexport const RealityPersistenceModeSchema = z.enum(['none', 'advisory', 'external']);\r\nexport type RealityPersistenceMode = z.infer<typeof RealityPersistenceModeSchema>;\r\n\r\n/**\r\n * Execution mode for Reality\r\n * - 'client': Browser/client-side, HTTP to external servers\r\n * - 'ssr-embedded': SSR with in-process server (TanStack/Vite)\r\n * - 'server-external': Dedicated server mode\r\n * - 'auto': Automatically detect based on environment\r\n */\r\nexport const RealityExecutionModeSchema = z.enum(['client', 'ssr-embedded', 'server-external', 'auto']);\r\nexport type RealityExecutionMode = z.infer<typeof RealityExecutionModeSchema>;\r\n\r\n// ============================================================================\r\n// Invalidation Adapter Interface\r\n// ============================================================================\r\n\r\n/**\r\n * Invalidation adapter for advisory database integration\r\n * Reality does NOT own your data - this is optional!\r\n */\r\nexport interface RealityInvalidationAdapter {\r\n  /** Hook called when keys should be invalidated */\r\n  onInvalidate(keys: string[]): Promise<void>;\r\n  /** Hook called before a transaction (for auto-invalidation) */\r\n  beforeTransaction?<T>(fn: () => Promise<T>): Promise<T>;\r\n  /** Hook called after a transaction (for auto-invalidation) */\r\n  afterTransaction?(affectedKeys: string[]): Promise<void>;\r\n}\r\n\r\n/**\r\n * Configuration for invalidation behavior\r\n */\r\nexport interface InvalidationConfig {\r\n  /** Invalidation adapter instance */\r\n  adapter?: RealityInvalidationAdapter;\r\n  /** Persistence mode */\r\n  mode?: RealityPersistenceMode;\r\n}\r\n\r\n// ============================================================================\r\n// Storage Interface (optional - Reality works without it)\r\n// ============================================================================\r\n\r\nexport interface RealityStorage {\r\n  /** Get metadata for a node */\r\n  getNode(key: string): Promise<RealityNodeMeta | null>;\r\n  /** Set metadata for a node */\r\n  setNode(meta: RealityNodeMeta): Promise<void>;\r\n  /** Increment version and update hash */\r\n  incrementVersion(key: string, hash: string): Promise<RealityNodeMeta>;\r\n  /** List nodes changed since a given version */\r\n  listChangedSince(version: number): Promise<RealityNodeMeta[]>;\r\n  /** Get multiple nodes by keys */\r\n  getNodes(keys: string[]): Promise<Map<string, RealityNodeMeta>>;\r\n  /** Get current max version across all nodes */\r\n  getMaxVersion(): Promise<number>;\r\n  /** Delete a node */\r\n  deleteNode(key: string): Promise<void>;\r\n  /** Health check */\r\n  isHealthy(): Promise<boolean>;\r\n}\r\n\r\n// ============================================================================\r\n// Database Adapter Interface\r\n// ============================================================================\r\n\r\nexport interface DatabaseAdapter {\r\n  /** Fetch payload for a key */\r\n  fetchPayload<T = unknown>(key: string): Promise<T | null>;\r\n  /** Store payload for a key */\r\n  storePayload<T = unknown>(key: string, payload: T): Promise<void>;\r\n  /** Delete payload */\r\n  deletePayload(key: string): Promise<void>;\r\n  /** Batch fetch payloads */\r\n  fetchPayloads<T = unknown>(keys: string[]): Promise<Map<string, T>>;\r\n}\r\n\r\n// ============================================================================\r\n// Server Configuration\r\n// ============================================================================\r\n\r\nexport const ServerConfigSchema = z.object({\r\n  /** Server identifier (unique across mesh) */\r\n  serverId: z.string().min(1),\r\n  /** HTTP port to listen on */\r\n  port: z.number().int().positive().default(3000),\r\n  /** Host to bind to */\r\n  host: z.string().default('0.0.0.0'),\r\n  /** Peer server URLs for mesh */\r\n  peers: z.array(z.string().url()).default([]),\r\n  /** CORS configuration */\r\n  cors: z.object({\r\n    origins: z.array(z.string()).default(['*']),\r\n    credentials: z.boolean().default(true),\r\n  }).default({}),\r\n  /** Rate limiting */\r\n  rateLimit: z.object({\r\n    enabled: z.boolean().default(false),\r\n    maxRequests: z.number().int().positive().default(100),\r\n    windowMs: z.number().int().positive().default(60000),\r\n  }).default({}),\r\n  /** Enable debug logging */\r\n  debug: z.boolean().default(false),\r\n  /** Storage configuration */\r\n  storage: z.object({\r\n    type: z.enum(['memory', 'drizzle', 'prisma', 'sql', 'dynamodb', 'redis', 'custom']).default('memory'),\r\n    connectionString: z.string().optional(),\r\n    tableName: z.string().default('reality_nodes'),\r\n  }).default({}),\r\n  /** Redis configuration (optional acceleration) */\r\n  redis: z.object({\r\n    enabled: z.boolean().default(false),\r\n    url: z.string().optional(),\r\n    prefix: z.string().default('reality:'),\r\n  }).default({}),\r\n  /** Payload fetcher base URL */\r\n  payloadBaseUrl: z.string().url().optional(),\r\n  /** Execution mode */\r\n  executionMode: RealityExecutionModeSchema.default('server-external'),\r\n  /** Invalidation configuration (optional) */\r\n  invalidation: z.object({\r\n    mode: RealityPersistenceModeSchema.default('none'),\r\n  }).default({}),\r\n});\r\n\r\nexport type ServerConfig = z.input<typeof ServerConfigSchema>;\r\nexport type ResolvedServerConfig = z.output<typeof ServerConfigSchema>;\r\n\r\n// ============================================================================\r\n// Mesh Types\r\n// ============================================================================\r\n\r\nexport interface PeerInfo {\r\n  url: string;\r\n  serverId: string;\r\n  health: PeerHealth;\r\n  maxVersionSeen: number;\r\n  lastSeen: number;\r\n  lastLatency: number;\r\n}\r\n\r\nexport interface MeshState {\r\n  serverId: string;\r\n  maxVersionSeen: number;\r\n  peers: Map<string, PeerInfo>;\r\n  lastGossipTime: number;\r\n}\r\n\r\nexport interface GossipPayload {\r\n  serverId: string;\r\n  maxVersion: number;\r\n  peerSummaries: Array<{\r\n    url: string;\r\n    health: PeerHealth;\r\n    maxVersion: number;\r\n    lastSeen: number;\r\n  }>;\r\n  timestamp: number;\r\n}\r\n\r\nexport const GossipPayloadSchema = z.object({\r\n  serverId: z.string(),\r\n  maxVersion: z.number().int().nonnegative(),\r\n  peerSummaries: z.array(z.object({\r\n    url: z.string().url(),\r\n    health: z.enum(['healthy', 'degraded', 'unhealthy', 'unknown']),\r\n    maxVersion: z.number().int().nonnegative(),\r\n    lastSeen: z.number().int(),\r\n  })),\r\n  timestamp: z.number().int(),\r\n});\r\n\r\n// ============================================================================\r\n// Request/Response Types\r\n// ============================================================================\r\n\r\nexport interface InvalidationRequest {\r\n  keys: string[];\r\n  source?: string;\r\n  timestamp?: number;\r\n}\r\n\r\nexport const InvalidationRequestSchema = z.object({\r\n  keys: z.array(z.string()).min(1),\r\n  source: z.string().optional(),\r\n  timestamp: z.number().int().optional(),\r\n});\r\n\r\nexport interface InvalidationResponse {\r\n  invalidated: string[];\r\n  versions: Record<string, number>;\r\n}\r\n\r\nexport interface HealthResponse {\r\n  status: 'healthy' | 'degraded' | 'unhealthy';\r\n  serverId: string;\r\n  version: string;\r\n  uptime: number;\r\n  mesh: {\r\n    peerCount: number;\r\n    healthyPeers: number;\r\n  };\r\n  storage: {\r\n    healthy: boolean;\r\n    maxVersion: number;\r\n  };\r\n  redis?: {\r\n    connected: boolean;\r\n  };\r\n}\r\n\r\n// ============================================================================\r\n// HTTP Handler Types\r\n// ============================================================================\r\n\r\nexport interface RealityRequest {\r\n  method: string;\r\n  url: string;\r\n  headers: Headers;\r\n  body: unknown;\r\n  params: Record<string, string>;\r\n  query: Record<string, string>;\r\n}\r\n\r\nexport interface RealityResponse {\r\n  status: number;\r\n  headers: Record<string, string>;\r\n  body: unknown;\r\n}\r\n\r\nexport type RealityHandler = (req: RealityRequest) => Promise<RealityResponse>;\r\n\r\n// ============================================================================\r\n// Middleware Types\r\n// ============================================================================\r\n\r\nexport type Middleware = (\r\n  req: RealityRequest,\r\n  next: () => Promise<RealityResponse>\r\n) => Promise<RealityResponse>;\r\n\r\n// ============================================================================\r\n// Storage Factory Types\r\n// ============================================================================\r\n\r\nexport interface StorageFactory {\r\n  create(config: ResolvedServerConfig): Promise<RealityStorage>;\r\n}\r\n\r\n// ============================================================================\r\n// Database Adapter Factory Types\r\n// ============================================================================\r\n\r\nexport interface DatabaseAdapterFactory {\r\n  create(config: ResolvedServerConfig): Promise<DatabaseAdapter>;\r\n}\r\n","/**\r\n * @rootlodge/reality-server - HTTP Handlers\r\n * \r\n * HTTP endpoint handlers for Reality server.\r\n * Framework-agnostic implementation.\r\n */\r\n\r\nimport { z } from 'zod';\r\nimport type {\r\n  RealityStorage,\r\n  RealityRequest,\r\n  RealityResponse,\r\n  SyncRequest,\r\n  SyncResponse,\r\n  ChangedNode,\r\n  InvalidationResponse,\r\n  HealthResponse,\r\n} from '../types';\r\nimport { SyncRequestSchema, InvalidationRequestSchema } from '../types';\r\nimport { MeshCoordinator } from '../mesh/coordinator';\r\nimport { RedisAccelerator } from '../redis/accelerator';\r\n\r\n/**\r\n * Handler dependencies\r\n */\r\nexport interface HandlerDeps {\r\n  storage: RealityStorage;\r\n  mesh: MeshCoordinator;\r\n  redis?: RedisAccelerator;\r\n  serverId: string;\r\n  version: string;\r\n  startTime: number;\r\n  debug?: boolean;\r\n  /** Optional: Fetch payload for a key */\r\n  payloadFetcher?: (key: string) => Promise<unknown>;\r\n}\r\n\r\n/**\r\n * Create JSON response\r\n */\r\nfunction jsonResponse(data: unknown, status = 200, headers: Record<string, string> = {}): RealityResponse {\r\n  return {\r\n    status,\r\n    headers: {\r\n      'Content-Type': 'application/json',\r\n      ...headers,\r\n    },\r\n    body: data,\r\n  };\r\n}\r\n\r\n/**\r\n * Create error response\r\n */\r\nfunction errorResponse(message: string, status = 400): RealityResponse {\r\n  return jsonResponse({ error: message }, status);\r\n}\r\n\r\n/**\r\n * Handle sync request\r\n * \r\n * This is the core endpoint that clients call to synchronize state.\r\n */\r\nexport async function handleSync(\r\n  req: RealityRequest,\r\n  deps: HandlerDeps\r\n): Promise<RealityResponse> {\r\n  // Parse and validate request\r\n  const parsed = SyncRequestSchema.safeParse(req.body);\r\n  if (!parsed.success) {\r\n    return errorResponse(`Invalid request: ${parsed.error.message}`);\r\n  }\r\n\r\n  const syncRequest: SyncRequest = parsed.data;\r\n  const { storage, mesh, redis: _redis, payloadFetcher } = deps;\r\n\r\n  try {\r\n    // Get all keys client is interested in\r\n    const keys = Object.keys(syncRequest.known);\r\n    \r\n    // Fetch current metadata for all keys\r\n    const nodeMetas = await storage.getNodes(keys);\r\n    \r\n    // Build changed map\r\n    const changed: Record<string, ChangedNode> = {};\r\n    \r\n    for (const [key, clientVersion] of Object.entries(syncRequest.known)) {\r\n      const meta = nodeMetas.get(key);\r\n      \r\n      if (!meta) {\r\n        // Key doesn't exist on server - could be deleted or never existed\r\n        // We report it as version 0 so client knows it's gone\r\n        changed[key] = {\r\n          version: 0,\r\n          hash: '',\r\n          source: deps.serverId,\r\n        };\r\n        continue;\r\n      }\r\n\r\n      // Check if client has stale version\r\n      if (meta.version > clientVersion) {\r\n        const changedNode: ChangedNode = {\r\n          version: meta.version,\r\n          hash: meta.hash,\r\n          source: deps.serverId,\r\n        };\r\n\r\n        // Include payload for small updates if fetcher is available\r\n        if (payloadFetcher) {\r\n          try {\r\n            const payload = await payloadFetcher(key);\r\n            // Only include if payload is small enough\r\n            const payloadStr = JSON.stringify(payload);\r\n            if (payloadStr.length < 1024) {\r\n              changedNode.payload = payload;\r\n            }\r\n          } catch {\r\n            // Payload fetch failed - client will need to fetch separately\r\n          }\r\n        }\r\n\r\n        changed[key] = changedNode;\r\n      }\r\n    }\r\n\r\n    // Update mesh max version\r\n    const maxVersion = await storage.getMaxVersion();\r\n    mesh.updateMaxVersion(maxVersion);\r\n\r\n    // Build response\r\n    const response: SyncResponse = {\r\n      changed,\r\n      mesh: {\r\n        peers: mesh.getPeerHealthMap(),\r\n        serverVersion: maxVersion,\r\n      },\r\n      serverTime: Date.now(),\r\n    };\r\n\r\n    // Create response with gossip header\r\n    const gossipHeader = JSON.stringify(mesh.createGossipPayload());\r\n\r\n    return jsonResponse(response, 200, {\r\n      'X-Reality-Gossip': gossipHeader,\r\n      'X-Reality-Server': deps.serverId,\r\n    });\r\n  } catch (error) {\r\n    const message = error instanceof Error ? error.message : 'Internal server error';\r\n    return errorResponse(message, 500);\r\n  }\r\n}\r\n\r\n/**\r\n * Handle invalidation request\r\n * \r\n * Called when data is updated to propagate invalidation to the mesh.\r\n */\r\nexport async function handleInvalidation(\r\n  req: RealityRequest,\r\n  deps: HandlerDeps\r\n): Promise<RealityResponse> {\r\n  const parsed = InvalidationRequestSchema.safeParse(req.body);\r\n  if (!parsed.success) {\r\n    return errorResponse(`Invalid request: ${parsed.error.message}`);\r\n  }\r\n\r\n  const { keys, source } = parsed.data;\r\n  const { storage, mesh, redis } = deps;\r\n\r\n  try {\r\n    const versions: Record<string, number> = {};\r\n    const invalidated: string[] = [];\r\n\r\n    // For each key, check if we need to sync from source\r\n    for (const key of keys) {\r\n      const meta = await storage.getNode(key);\r\n      if (meta) {\r\n        versions[key] = meta.version;\r\n        invalidated.push(key);\r\n      }\r\n    }\r\n\r\n    // Invalidate Redis cache if available\r\n    if (redis?.isConnected()) {\r\n      for (const key of keys) {\r\n        await redis.invalidateCache(key);\r\n      }\r\n      \r\n      // Publish to other servers\r\n      await redis.publishInvalidation(keys);\r\n    }\r\n\r\n    // Propagate to mesh peers (fire and forget)\r\n    if (source !== deps.serverId) {\r\n      mesh.propagateInvalidation(keys);\r\n    }\r\n\r\n    const response: InvalidationResponse = {\r\n      invalidated,\r\n      versions,\r\n    };\r\n\r\n    return jsonResponse(response, 200, {\r\n      'X-Reality-Gossip': JSON.stringify(mesh.createGossipPayload()),\r\n      'X-Reality-Server': deps.serverId,\r\n    });\r\n  } catch (error) {\r\n    const message = error instanceof Error ? error.message : 'Internal server error';\r\n    return errorResponse(message, 500);\r\n  }\r\n}\r\n\r\n/**\r\n * Handle version query\r\n * \r\n * Returns all versions changed since a given version.\r\n * Used for peer-to-peer sync.\r\n */\r\nexport async function handleVersionQuery(\r\n  req: RealityRequest,\r\n  deps: HandlerDeps\r\n): Promise<RealityResponse> {\r\n  const since = parseInt(req.query.since ?? '0', 10);\r\n  \r\n  if (isNaN(since) || since < 0) {\r\n    return errorResponse('Invalid since parameter');\r\n  }\r\n\r\n  try {\r\n    const changed = await deps.storage.listChangedSince(since);\r\n    \r\n    return jsonResponse({\r\n      ...deps.mesh.createGossipPayload(),\r\n      changed: changed.map((meta) => ({\r\n        key: meta.key,\r\n        version: meta.version,\r\n        hash: meta.hash,\r\n      })),\r\n    }, 200, {\r\n      'X-Reality-Server': deps.serverId,\r\n    });\r\n  } catch (error) {\r\n    const message = error instanceof Error ? error.message : 'Internal server error';\r\n    return errorResponse(message, 500);\r\n  }\r\n}\r\n\r\n/**\r\n * Handle health check\r\n */\r\nexport async function handleHealth(\r\n  _req: RealityRequest,\r\n  deps: HandlerDeps\r\n): Promise<RealityResponse> {\r\n  const { storage, mesh, redis, serverId, version, startTime } = deps;\r\n\r\n  try {\r\n    const storageHealthy = await storage.isHealthy();\r\n    const maxVersion = await storage.getMaxVersion();\r\n    const meshStats = mesh.getStats();\r\n    \r\n    let status: 'healthy' | 'degraded' | 'unhealthy' = 'healthy';\r\n    \r\n    if (!storageHealthy) {\r\n      status = 'unhealthy';\r\n    } else if (meshStats.healthyPeerCount === 0 && meshStats.peerCount > 0) {\r\n      status = 'degraded';\r\n    }\r\n\r\n    const response: HealthResponse = {\r\n      status,\r\n      serverId,\r\n      version,\r\n      uptime: Date.now() - startTime,\r\n      mesh: {\r\n        peerCount: meshStats.peerCount,\r\n        healthyPeers: meshStats.healthyPeerCount,\r\n      },\r\n      storage: {\r\n        healthy: storageHealthy,\r\n        maxVersion,\r\n      },\r\n    };\r\n\r\n    if (redis) {\r\n      response.redis = {\r\n        connected: redis.isConnected(),\r\n      };\r\n    }\r\n\r\n    return jsonResponse(response, status === 'unhealthy' ? 503 : 200);\r\n  } catch (error) {\r\n    return jsonResponse({\r\n      status: 'unhealthy',\r\n      error: error instanceof Error ? error.message : 'Unknown error',\r\n    }, 503);\r\n  }\r\n}\r\n\r\n/**\r\n * Handle node update (write)\r\n * \r\n * Called when data is written to update the invalidation graph.\r\n */\r\nexport async function handleNodeUpdate(\r\n  req: RealityRequest,\r\n  deps: HandlerDeps\r\n): Promise<RealityResponse> {\r\n  const schema = z.object({\r\n    key: z.string().min(1),\r\n    hash: z.string().min(1),\r\n  });\r\n\r\n  const parsed = schema.safeParse(req.body);\r\n  if (!parsed.success) {\r\n    return errorResponse(`Invalid request: ${parsed.error.message}`);\r\n  }\r\n\r\n  const { key, hash } = parsed.data;\r\n  const { storage, mesh, redis } = deps;\r\n\r\n  try {\r\n    // Increment version in storage\r\n    const meta = await storage.incrementVersion(key, hash);\r\n\r\n    // Update mesh max version\r\n    mesh.updateMaxVersion(meta.version);\r\n\r\n    // Invalidate and propagate\r\n    if (redis?.isConnected()) {\r\n      await redis.invalidateCache(key);\r\n      await redis.publishInvalidation([key]);\r\n    }\r\n\r\n    // Propagate to peers\r\n    mesh.propagateInvalidation([key]);\r\n\r\n    return jsonResponse({\r\n      key: meta.key,\r\n      version: meta.version,\r\n      hash: meta.hash,\r\n      updatedAt: meta.updatedAt,\r\n    }, 200, {\r\n      'X-Reality-Gossip': JSON.stringify(mesh.createGossipPayload()),\r\n      'X-Reality-Server': deps.serverId,\r\n    });\r\n  } catch (error) {\r\n    const message = error instanceof Error ? error.message : 'Internal server error';\r\n    return errorResponse(message, 500);\r\n  }\r\n}\r\n\r\n/**\r\n * Handle CORS preflight\r\n */\r\nexport function handleCors(\r\n  _req: RealityRequest,\r\n  origins: string[]\r\n): RealityResponse {\r\n  const allowOrigin = origins.includes('*') ? '*' : origins[0] ?? '*';\r\n  \r\n  return {\r\n    status: 204,\r\n    headers: {\r\n      'Access-Control-Allow-Origin': allowOrigin,\r\n      'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',\r\n      'Access-Control-Allow-Headers': 'Content-Type, X-Reality-Server, X-Reality-Gossip',\r\n      'Access-Control-Max-Age': '86400',\r\n    },\r\n    body: null,\r\n  };\r\n}\r\n","/**\r\n * @rootlodge/reality-server - Express Adapter\r\n * \r\n * Adapter for Express.js framework.\r\n */\r\n\r\nimport type { RealityRequest } from '../types';\r\nimport type { HandlerDeps } from './handlers';\r\nimport {\r\n  handleSync,\r\n  handleInvalidation,\r\n  handleVersionQuery,\r\n  handleHealth,\r\n  handleNodeUpdate,\r\n  handleCors,\r\n} from './handlers';\r\n\r\n/**\r\n * Express-compatible request\r\n */\r\ninterface ExpressRequest {\r\n  method: string;\r\n  url: string;\r\n  originalUrl: string;\r\n  path: string;\r\n  headers: Record<string, string | string[] | undefined>;\r\n  body: unknown;\r\n  params: Record<string, string>;\r\n  query: Record<string, string | string[] | undefined>;\r\n}\r\n\r\n/**\r\n * Express-compatible response\r\n */\r\ninterface ExpressResponse {\r\n  status(code: number): ExpressResponse;\r\n  set(headers: Record<string, string>): ExpressResponse;\r\n  json(data: unknown): void;\r\n  send(data: unknown): void;\r\n  end(): void;\r\n}\r\n\r\n/**\r\n * Express middleware type\r\n */\r\ntype ExpressMiddleware = (\r\n  req: ExpressRequest,\r\n  res: ExpressResponse,\r\n  next: () => void\r\n) => void | Promise<void>;\r\n\r\n/**\r\n * Convert Express request to Reality request\r\n */\r\nfunction toRealityRequest(req: ExpressRequest): RealityRequest {\r\n  const headers = new Headers();\r\n  for (const [key, value] of Object.entries(req.headers)) {\r\n    if (value) {\r\n      headers.set(key, Array.isArray(value) ? value[0] ?? '' : value);\r\n    }\r\n  }\r\n\r\n  const query: Record<string, string> = {};\r\n  for (const [key, value] of Object.entries(req.query)) {\r\n    if (value) {\r\n      query[key] = Array.isArray(value) ? value[0] ?? '' : value;\r\n    }\r\n  }\r\n\r\n  return {\r\n    method: req.method,\r\n    url: req.originalUrl,\r\n    headers,\r\n    body: req.body,\r\n    params: req.params,\r\n    query,\r\n  };\r\n}\r\n\r\n/**\r\n * Create Express middleware for Reality server\r\n * \r\n * @example\r\n * ```typescript\r\n * import express from 'express';\r\n * import { createExpressMiddleware } from '@rootlodge/reality-server/http';\r\n * \r\n * const app = express();\r\n * app.use(express.json());\r\n * \r\n * const realityMiddleware = createExpressMiddleware({\r\n *   storage,\r\n *   mesh,\r\n *   serverId: 'server-1',\r\n *   version: '1.0.0',\r\n *   startTime: Date.now(),\r\n * });\r\n * \r\n * app.use('/reality', realityMiddleware);\r\n * ```\r\n */\r\nexport function createExpressMiddleware(deps: HandlerDeps): ExpressMiddleware {\r\n  return async (req: ExpressRequest, res: ExpressResponse, next: () => void) => {\r\n    const realityReq = toRealityRequest(req);\r\n    \r\n    // Handle CORS preflight\r\n    if (req.method === 'OPTIONS') {\r\n      const corsResponse = handleCors(realityReq, ['*']);\r\n      res.status(corsResponse.status).set(corsResponse.headers).end();\r\n      return;\r\n    }\r\n\r\n    // Route to appropriate handler\r\n    let response;\r\n    \r\n    try {\r\n      switch (req.path) {\r\n        case '/sync':\r\n          if (req.method !== 'POST') {\r\n            res.status(405).json({ error: 'Method not allowed' });\r\n            return;\r\n          }\r\n          response = await handleSync(realityReq, deps);\r\n          break;\r\n\r\n        case '/invalidate':\r\n          if (req.method !== 'POST') {\r\n            res.status(405).json({ error: 'Method not allowed' });\r\n            return;\r\n          }\r\n          response = await handleInvalidation(realityReq, deps);\r\n          break;\r\n\r\n        case '/versions':\r\n          if (req.method !== 'GET') {\r\n            res.status(405).json({ error: 'Method not allowed' });\r\n            return;\r\n          }\r\n          response = await handleVersionQuery(realityReq, deps);\r\n          break;\r\n\r\n        case '/health':\r\n          response = await handleHealth(realityReq, deps);\r\n          break;\r\n\r\n        case '/update':\r\n          if (req.method !== 'POST') {\r\n            res.status(405).json({ error: 'Method not allowed' });\r\n            return;\r\n          }\r\n          response = await handleNodeUpdate(realityReq, deps);\r\n          break;\r\n\r\n        default:\r\n          // Not a Reality route, pass to next middleware\r\n          next();\r\n          return;\r\n      }\r\n\r\n      // Send response\r\n      res.status(response.status).set(response.headers).json(response.body);\r\n    } catch (error) {\r\n      res.status(500).json({\r\n        error: error instanceof Error ? error.message : 'Internal server error',\r\n      });\r\n    }\r\n  };\r\n}\r\n\r\n/**\r\n * Create Express router with all Reality routes\r\n * \r\n * For use with app.use() when you want Reality at a specific path prefix.\r\n */\r\nexport function createExpressRouter(deps: HandlerDeps) {\r\n  // Return an object that can be used with minimal Express-like setup\r\n  const routes: Array<{\r\n    method: 'get' | 'post' | 'options';\r\n    path: string;\r\n    handler: (req: ExpressRequest, res: ExpressResponse) => Promise<void>;\r\n  }> = [\r\n    {\r\n      method: 'options',\r\n      path: '*',\r\n      handler: async (req, res) => {\r\n        const response = handleCors(toRealityRequest(req), ['*']);\r\n        res.status(response.status).set(response.headers).end();\r\n      },\r\n    },\r\n    {\r\n      method: 'post',\r\n      path: '/sync',\r\n      handler: async (req, res) => {\r\n        const response = await handleSync(toRealityRequest(req), deps);\r\n        res.status(response.status).set(response.headers).json(response.body);\r\n      },\r\n    },\r\n    {\r\n      method: 'post',\r\n      path: '/invalidate',\r\n      handler: async (req, res) => {\r\n        const response = await handleInvalidation(toRealityRequest(req), deps);\r\n        res.status(response.status).set(response.headers).json(response.body);\r\n      },\r\n    },\r\n    {\r\n      method: 'get',\r\n      path: '/versions',\r\n      handler: async (req, res) => {\r\n        const response = await handleVersionQuery(toRealityRequest(req), deps);\r\n        res.status(response.status).set(response.headers).json(response.body);\r\n      },\r\n    },\r\n    {\r\n      method: 'get',\r\n      path: '/health',\r\n      handler: async (req, res) => {\r\n        const response = await handleHealth(toRealityRequest(req), deps);\r\n        res.status(response.status).set(response.headers).json(response.body);\r\n      },\r\n    },\r\n    {\r\n      method: 'post',\r\n      path: '/update',\r\n      handler: async (req, res) => {\r\n        const response = await handleNodeUpdate(toRealityRequest(req), deps);\r\n        res.status(response.status).set(response.headers).json(response.body);\r\n      },\r\n    },\r\n  ];\r\n\r\n  return { routes };\r\n}\r\n","/**\r\n * @rootlodge/reality-server - Fetch API Handler\r\n * \r\n * Universal handler using the Fetch API standard.\r\n * Works with Cloudflare Workers, Deno, Bun, Node.js 18+, and any edge runtime.\r\n */\r\n\r\nimport type { RealityRequest } from '../types';\r\nimport type { HandlerDeps } from './handlers';\r\nimport {\r\n  handleSync,\r\n  handleInvalidation,\r\n  handleVersionQuery,\r\n  handleHealth,\r\n  handleNodeUpdate,\r\n  handleCors,\r\n} from './handlers';\r\n\r\n/**\r\n * Route configuration\r\n */\r\ninterface RouteConfig {\r\n  /** Base path for Reality routes (e.g., '/reality') */\r\n  basePath?: string;\r\n  /** CORS origins */\r\n  corsOrigins?: string[];\r\n}\r\n\r\n/**\r\n * Convert Fetch Request to Reality request\r\n */\r\nasync function toRealityRequest(request: Request): Promise<RealityRequest> {\r\n  const url = new URL(request.url);\r\n  \r\n  let body: unknown = null;\r\n  if (request.method !== 'GET' && request.method !== 'HEAD') {\r\n    try {\r\n      body = await request.json();\r\n    } catch {\r\n      body = null;\r\n    }\r\n  }\r\n\r\n  const query: Record<string, string> = {};\r\n  for (const [key, value] of url.searchParams) {\r\n    query[key] = value;\r\n  }\r\n\r\n  return {\r\n    method: request.method,\r\n    url: request.url,\r\n    headers: request.headers,\r\n    body,\r\n    params: {},\r\n    query,\r\n  };\r\n}\r\n\r\n/**\r\n * Convert Reality response to Fetch Response\r\n */\r\nfunction toFetchResponse(realityResponse: { status: number; headers: Record<string, string>; body: unknown }): Response {\r\n  const body = realityResponse.body !== null\r\n    ? JSON.stringify(realityResponse.body)\r\n    : null;\r\n\r\n  return new Response(body, {\r\n    status: realityResponse.status,\r\n    headers: realityResponse.headers,\r\n  });\r\n}\r\n\r\n/**\r\n * Create a Fetch API handler for Reality server\r\n * \r\n * This is the universal handler that works with any runtime supporting Fetch API.\r\n * \r\n * @example\r\n * ```typescript\r\n * // Cloudflare Workers\r\n * import { createFetchHandler } from '@rootlodge/reality-server/http';\r\n * \r\n * const handler = createFetchHandler(deps, { basePath: '/reality' });\r\n * \r\n * export default {\r\n *   fetch: handler,\r\n * };\r\n * ```\r\n * \r\n * @example\r\n * ```typescript\r\n * // Deno\r\n * import { createFetchHandler } from '@rootlodge/reality-server/http';\r\n * \r\n * const handler = createFetchHandler(deps, { basePath: '/reality' });\r\n * \r\n * Deno.serve({ port: 3000 }, handler);\r\n * ```\r\n * \r\n * @example\r\n * ```typescript\r\n * // Bun\r\n * import { createFetchHandler } from '@rootlodge/reality-server/http';\r\n * \r\n * const handler = createFetchHandler(deps, { basePath: '/reality' });\r\n * \r\n * Bun.serve({ port: 3000, fetch: handler });\r\n * ```\r\n * \r\n * @example\r\n * ```typescript\r\n * // Node.js 18+ with native fetch\r\n * import { createServer } from 'http';\r\n * import { createFetchHandler } from '@rootlodge/reality-server/http';\r\n * \r\n * const handler = createFetchHandler(deps, { basePath: '/reality' });\r\n * \r\n * createServer(async (req, res) => {\r\n *   const url = `http://${req.headers.host}${req.url}`;\r\n *   const request = new Request(url, {\r\n *     method: req.method,\r\n *     headers: req.headers as HeadersInit,\r\n *     body: req.method !== 'GET' && req.method !== 'HEAD' ? req : undefined,\r\n *   });\r\n *   const response = await handler(request);\r\n *   res.writeHead(response.status, Object.fromEntries(response.headers));\r\n *   res.end(await response.text());\r\n * }).listen(3000);\r\n * ```\r\n */\r\nexport function createFetchHandler(\r\n  deps: HandlerDeps,\r\n  config: RouteConfig = {}\r\n): (request: Request) => Promise<Response> {\r\n  const basePath = config.basePath ?? '/reality';\r\n  const corsOrigins = config.corsOrigins ?? ['*'];\r\n\r\n  return async (request: Request): Promise<Response> => {\r\n    const url = new URL(request.url);\r\n    const path = url.pathname;\r\n\r\n    // Check if this is a Reality route\r\n    if (!path.startsWith(basePath)) {\r\n      return new Response('Not Found', { status: 404 });\r\n    }\r\n\r\n    // Get the route path (without base path)\r\n    const routePath = path.slice(basePath.length) || '/';\r\n\r\n    // Handle CORS preflight\r\n    if (request.method === 'OPTIONS') {\r\n      const realityReq = await toRealityRequest(request);\r\n      const response = handleCors(realityReq, corsOrigins);\r\n      return toFetchResponse(response);\r\n    }\r\n\r\n    // Add CORS headers to all responses\r\n    const corsHeaders: Record<string, string> = {\r\n      'Access-Control-Allow-Origin': corsOrigins.includes('*') ? '*' : corsOrigins[0] ?? '*',\r\n      'Access-Control-Allow-Credentials': 'true',\r\n    };\r\n\r\n    try {\r\n      const realityReq = await toRealityRequest(request);\r\n      let response;\r\n\r\n      switch (routePath) {\r\n        case '/sync':\r\n          if (request.method !== 'POST') {\r\n            return new Response(JSON.stringify({ error: 'Method not allowed' }), {\r\n              status: 405,\r\n              headers: { 'Content-Type': 'application/json', ...corsHeaders },\r\n            });\r\n          }\r\n          response = await handleSync(realityReq, deps);\r\n          break;\r\n\r\n        case '/invalidate':\r\n          if (request.method !== 'POST') {\r\n            return new Response(JSON.stringify({ error: 'Method not allowed' }), {\r\n              status: 405,\r\n              headers: { 'Content-Type': 'application/json', ...corsHeaders },\r\n            });\r\n          }\r\n          response = await handleInvalidation(realityReq, deps);\r\n          break;\r\n\r\n        case '/versions':\r\n          if (request.method !== 'GET') {\r\n            return new Response(JSON.stringify({ error: 'Method not allowed' }), {\r\n              status: 405,\r\n              headers: { 'Content-Type': 'application/json', ...corsHeaders },\r\n            });\r\n          }\r\n          response = await handleVersionQuery(realityReq, deps);\r\n          break;\r\n\r\n        case '/health':\r\n        case '/':\r\n          response = await handleHealth(realityReq, deps);\r\n          break;\r\n\r\n        case '/update':\r\n          if (request.method !== 'POST') {\r\n            return new Response(JSON.stringify({ error: 'Method not allowed' }), {\r\n              status: 405,\r\n              headers: { 'Content-Type': 'application/json', ...corsHeaders },\r\n            });\r\n          }\r\n          response = await handleNodeUpdate(realityReq, deps);\r\n          break;\r\n\r\n        default:\r\n          return new Response(JSON.stringify({ error: 'Not found' }), {\r\n            status: 404,\r\n            headers: { 'Content-Type': 'application/json', ...corsHeaders },\r\n          });\r\n      }\r\n\r\n      // Merge CORS headers\r\n      response.headers = { ...response.headers, ...corsHeaders };\r\n      return toFetchResponse(response);\r\n    } catch (error) {\r\n      return new Response(\r\n        JSON.stringify({\r\n          error: error instanceof Error ? error.message : 'Internal server error',\r\n        }),\r\n        {\r\n          status: 500,\r\n          headers: { 'Content-Type': 'application/json', ...corsHeaders },\r\n        }\r\n      );\r\n    }\r\n  };\r\n}\r\n\r\n/**\r\n * Create a Cloudflare Workers compatible handler\r\n */\r\nexport function createWorkersHandler(\r\n  deps: HandlerDeps,\r\n  config: RouteConfig = {}\r\n): { fetch: (request: Request) => Promise<Response> } {\r\n  const handler = createFetchHandler(deps, config);\r\n  return { fetch: handler };\r\n}\r\n"]}